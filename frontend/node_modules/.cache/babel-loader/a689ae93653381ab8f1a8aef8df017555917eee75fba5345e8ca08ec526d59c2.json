{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WSSecurityCertWithToken = void 0;\nconst crypto_1 = require(\"crypto\");\nconst xml_crypto_1 = require(\"xml-crypto\");\nfunction addMinutes(date, minutes) {\n  return new Date(date.getTime() + minutes * 60000);\n}\nfunction dateStringForSOAP(date) {\n  return date.getUTCFullYear() + '-' + ('0' + (date.getUTCMonth() + 1)).slice(-2) + '-' + ('0' + date.getUTCDate()).slice(-2) + 'T' + ('0' + date.getUTCHours()).slice(-2) + ':' + ('0' + date.getUTCMinutes()).slice(-2) + ':' + ('0' + date.getUTCSeconds()).slice(-2) + 'Z';\n}\nfunction generateCreated() {\n  return dateStringForSOAP(new Date());\n}\nfunction generateExpires() {\n  return dateStringForSOAP(addMinutes(new Date(), 10));\n}\nfunction insertStr(src, dst, pos) {\n  return [dst.slice(0, pos), src, dst.slice(pos)].join('');\n}\nfunction generateId() {\n  return (0, crypto_1.randomUUID)().replace(/-/gm, '');\n}\nfunction resolvePlaceholderInReferences(references, bodyXpath) {\n  for (const ref of references) {\n    if (ref.xpath === bodyXpathPlaceholder) {\n      ref.xpath = bodyXpath;\n    }\n  }\n}\nconst oasisBaseUri = 'http://docs.oasis-open.org/wss/2004/01';\nconst bodyXpathPlaceholder = '[[bodyXpath]]';\nclass WSSecurityCertWithToken {\n  constructor(props) {\n    this.signerOptions = {};\n    this.additionalReferences = [];\n    this.publicP12PEM = props.publicKey.toString().replace('-----BEGIN CERTIFICATE-----', '').replace('-----END CERTIFICATE-----', '').replace(/(\\r\\n|\\n|\\r)/gm, '');\n    this.username = props.username;\n    this.password = props.password;\n    this.signer = new xml_crypto_1.SignedXml();\n    const opts = props.options || {};\n    if (opts.signatureAlgorithm === 'http://www.w3.org/2001/04/xmldsig-more#rsa-sha256') {\n      this.signer.signatureAlgorithm = opts.signatureAlgorithm;\n      this.signer.addReference({\n        xpath: bodyXpathPlaceholder,\n        transforms: ['http://www.w3.org/2001/10/xml-exc-c14n#'],\n        digestAlgorithm: 'http://www.w3.org/2001/04/xmlenc#sha256'\n      });\n    }\n    if (!opts.signatureAlgorithm) {\n      this.signer.signatureAlgorithm = 'http://www.w3.org/2001/04/xmldsig-more#rsa-sha256';\n    }\n    this.signer.canonicalizationAlgorithm = 'http://www.w3.org/2001/10/xml-exc-c14n#';\n    if (opts.additionalReferences && opts.additionalReferences.length > 0) {\n      this.additionalReferences = opts.additionalReferences;\n    }\n    if (opts.signerOptions) {\n      const {\n        signerOptions\n      } = props.options;\n      this.signerOptions = signerOptions;\n      if (!this.signerOptions.existingPrefixes) {\n        this.signerOptions.existingPrefixes = {};\n      }\n      if (this.signerOptions.existingPrefixes && !this.signerOptions.existingPrefixes.wsse) {\n        this.signerOptions.existingPrefixes.wsse = `${oasisBaseUri}/oasis-200401-wss-wssecurity-secext-1.0.xsd`;\n      }\n    } else {\n      this.signerOptions = {\n        existingPrefixes: {\n          wsse: `${oasisBaseUri}/oasis-200401-wss-wssecurity-secext-1.0.xsd`\n        }\n      };\n    }\n    this.signer.privateKey = {\n      key: props.privateKey,\n      passphrase: props.keyPassword\n    };\n    this.x509Id = `x509-${generateId()}`;\n    this.hasTimeStamp = typeof opts.hasTimeStamp === 'undefined' ? true : !!opts.hasTimeStamp;\n    this.signatureTransformations = Array.isArray(opts.signatureTransformations) ? opts.signatureTransformations : ['http://www.w3.org/2000/09/xmldsig#enveloped-signature', 'http://www.w3.org/2001/10/xml-exc-c14n#'];\n    this.signer.keyInfoProvider = {};\n    this.signer.getKeyInfo = key => {\n      return `<wsse:SecurityTokenReference>` + `<wsse:Reference URI=\"#${this.x509Id}\" ValueType=\"${oasisBaseUri}/oasis-200401-wss-x509-token-profile-1.0#X509v3\"/>` + `</wsse:SecurityTokenReference>`;\n    };\n  }\n  postProcess(xml, envelopeKey) {\n    this.created = generateCreated();\n    this.expires = generateExpires();\n    let timestampStr = '';\n    if (this.hasTimeStamp) {\n      timestampStr = `<Timestamp xmlns=\"${oasisBaseUri}/oasis-200401-wss-wssecurity-utility-1.0.xsd\" Id=\"_1\">` + `<Created>${this.created}</Created>` + `<Expires>${this.expires}</Expires>` + `</Timestamp>`;\n    }\n    let usernameToken = '';\n    if (this.username) {\n      usernameToken = `<wsse:UsernameToken wsu:Id=\"SecurityToken-${this.created}\" xmlns:wsu=\"http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd\">` + `<wsse:Username>${this.username}</wsse:Username> ` + `<wsse:Password>${this.password}</wsse:Password> ` + `</wsse:UsernameToken>`;\n    }\n    const secHeader = `<wsse:Security xmlns:wsse=\"${oasisBaseUri}/oasis-200401-wss-wssecurity-secext-1.0.xsd\" ` + `xmlns:wsu=\"${oasisBaseUri}/oasis-200401-wss-wssecurity-utility-1.0.xsd\" ` + `${envelopeKey}:mustUnderstand=\"1\">` + `<wsse:BinarySecurityToken ` + `EncodingType=\"${oasisBaseUri}/oasis-200401-wss-soap-message-security-1.0#Base64Binary\" ` + `ValueType=\"${oasisBaseUri}/oasis-200401-wss-x509-token-profile-1.0#X509v3\" ` + `wsu:Id=\"${this.x509Id}\">${this.publicP12PEM}</wsse:BinarySecurityToken>` + usernameToken + timestampStr + `</wsse:Security>`;\n    const xmlWithSec = insertStr(secHeader, xml, xml.indexOf(`</${envelopeKey}:Header>`));\n    const references = this.signatureTransformations;\n    const bodyXpath = `//*[name(.)='${envelopeKey}:Body']`;\n    resolvePlaceholderInReferences(this.signer.references, bodyXpath);\n    if (!(this.signer.references.filter(ref => ref.xpath === bodyXpath).length > 0)) {\n      this.signer.addReference({\n        xpath: bodyXpath,\n        transforms: references,\n        digestAlgorithm: 'http://www.w3.org/2001/04/xmlenc#sha256'\n      });\n    }\n    for (const name of this.additionalReferences) {\n      const xpath = `//*[name(.)='${name}']`;\n      if (!(this.signer.references.filter(ref => ref.xpath === xpath).length > 0)) {\n        this.signer.addReference({\n          xpath: xpath,\n          transforms: references,\n          digestAlgorithm: 'http://www.w3.org/2001/04/xmlenc#sha256'\n        });\n      }\n    }\n    const timestampXpath = `//*[name(.)='wsse:Security']/*[local-name(.)='Timestamp']`;\n    if (this.hasTimeStamp && !(this.signer.references.filter(ref => ref.xpath === timestampXpath).length > 0)) {\n      this.signer.addReference({\n        xpath: timestampXpath,\n        transforms: references,\n        digestAlgorithm: 'http://www.w3.org/2001/04/xmlenc#sha256'\n      });\n    }\n    this.signer.computeSignature(xmlWithSec, this.signerOptions);\n    return insertStr(this.signer.getSignatureXml(), xmlWithSec, xmlWithSec.indexOf('</wsse:Security>'));\n  }\n}\nexports.WSSecurityCertWithToken = WSSecurityCertWithToken;","map":{"version":3,"names":["crypto_1","require","xml_crypto_1","addMinutes","date","minutes","Date","getTime","dateStringForSOAP","getUTCFullYear","getUTCMonth","slice","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","generateCreated","generateExpires","insertStr","src","dst","pos","join","generateId","randomUUID","replace","resolvePlaceholderInReferences","references","bodyXpath","ref","xpath","bodyXpathPlaceholder","oasisBaseUri","WSSecurityCertWithToken","constructor","props","signerOptions","additionalReferences","publicP12PEM","publicKey","toString","username","password","signer","SignedXml","opts","options","signatureAlgorithm","addReference","transforms","digestAlgorithm","canonicalizationAlgorithm","length","existingPrefixes","wsse","privateKey","key","passphrase","keyPassword","x509Id","hasTimeStamp","signatureTransformations","Array","isArray","keyInfoProvider","getKeyInfo","postProcess","xml","envelopeKey","created","expires","timestampStr","usernameToken","secHeader","xmlWithSec","indexOf","filter","name","timestampXpath","computeSignature","getSignatureXml","exports"],"sources":["../../src/security/WSSecurityCertWithToken.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}