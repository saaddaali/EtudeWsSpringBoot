{"ast":null,"code":"'use strict';\n\n// Original source at https://github.com/elasticio/node-ntlm-client/blob/master/lib/hash.js\nvar crypto = require('crypto');\nvar desjs = require('des.js');\nvar md4 = require('js-md4');\nfunction createLMResponse(challenge, lmhash) {\n  var buf = new Buffer.alloc(24),\n    pwBuffer = new Buffer.alloc(21).fill(0);\n  lmhash.copy(pwBuffer);\n  calculateDES(pwBuffer.slice(0, 7), challenge).copy(buf);\n  calculateDES(pwBuffer.slice(7, 14), challenge).copy(buf, 8);\n  calculateDES(pwBuffer.slice(14), challenge).copy(buf, 16);\n  return buf;\n}\nfunction createLMHash(password) {\n  var buf = new Buffer.alloc(16),\n    pwBuffer = new Buffer.alloc(14),\n    magicKey = new Buffer.from('KGS!@#$%', 'ascii');\n  if (password.length > 14) {\n    buf.fill(0);\n    return buf;\n  }\n  pwBuffer.fill(0);\n  pwBuffer.write(password.toUpperCase(), 0, 'ascii');\n  return Buffer.concat([calculateDES(pwBuffer.slice(0, 7), magicKey), calculateDES(pwBuffer.slice(7), magicKey)]);\n}\nfunction calculateDES(key, message) {\n  var desKey = new Buffer.alloc(8);\n  desKey[0] = key[0] & 0xFE;\n  desKey[1] = key[0] << 7 & 0xFF | key[1] >> 1;\n  desKey[2] = key[1] << 6 & 0xFF | key[2] >> 2;\n  desKey[3] = key[2] << 5 & 0xFF | key[3] >> 3;\n  desKey[4] = key[3] << 4 & 0xFF | key[4] >> 4;\n  desKey[5] = key[4] << 3 & 0xFF | key[5] >> 5;\n  desKey[6] = key[5] << 2 & 0xFF | key[6] >> 6;\n  desKey[7] = key[6] << 1 & 0xFF;\n  for (var i = 0; i < 8; i++) {\n    var parity = 0;\n    for (var j = 1; j < 8; j++) {\n      parity += (desKey[i] >> j) % 2;\n    }\n    desKey[i] |= parity % 2 === 0 ? 1 : 0;\n  }\n  var des = des.DES.create({\n    type: 'encrypt',\n    ley: desKey\n  });\n  return des.update(message);\n}\nfunction createNTLMResponse(challenge, ntlmhash) {\n  var buf = new Buffer.alloc(24),\n    ntlmBuffer = new Buffer.alloc(21).fill(0);\n  ntlmhash.copy(ntlmBuffer);\n  calculateDES(ntlmBuffer.slice(0, 7), challenge).copy(buf);\n  calculateDES(ntlmBuffer.slice(7, 14), challenge).copy(buf, 8);\n  calculateDES(ntlmBuffer.slice(14), challenge).copy(buf, 16);\n  return buf;\n}\nfunction createNTLMHash(password) {\n  var md4sum = md4.create();\n  md4sum.update(new Buffer.from(password, 'ucs2'));\n  return md4sum.buffer();\n}\nfunction createNTLMv2Hash(ntlmhash, username, authTargetName) {\n  var hmac = crypto.createHmac('md5', ntlmhash);\n  hmac.update(new Buffer.from(username.toUpperCase() + authTargetName, 'ucs2'));\n  return hmac.digest();\n}\nfunction createLMv2Response(type2message, username, ntlmhash, nonce, targetName) {\n  var buf = new Buffer.alloc(24),\n    ntlm2hash = createNTLMv2Hash(ntlmhash, username, targetName),\n    hmac = crypto.createHmac('md5', ntlm2hash);\n  //server challenge\n  type2message.challenge.copy(buf, 8);\n  //client nonce\n  buf.write(nonce || createPseudoRandomValue(16), 16, 'hex');\n  //create hash\n  hmac.update(buf.slice(8));\n  var hashedBuffer = hmac.digest();\n  hashedBuffer.copy(buf);\n  return buf;\n}\nfunction createNTLMv2Response(type2message, username, ntlmhash, nonce, targetName) {\n  var buf = new Buffer.alloc(48 + type2message.targetInfo.buffer.length),\n    ntlm2hash = createNTLMv2Hash(ntlmhash, username, targetName),\n    hmac = crypto.createHmac('md5', ntlm2hash);\n  //the first 8 bytes are spare to store the hashed value before the blob\n  //server challenge\n  type2message.challenge.copy(buf, 8);\n  //blob signature\n  buf.writeUInt32BE(0x01010000, 16);\n  //reserved\n  buf.writeUInt32LE(0, 20);\n  //timestamp\n  //TODO: we are loosing precision here since js is not able to handle those large integers\n  // maybe think about a different solution here\n  // 11644473600000 = diff between 1970 and 1601\n  var timestamp = ((Date.now() + 11644473600000) * 10000).toString(16);\n  var timestampLow = Number('0x' + timestamp.substring(Math.max(0, timestamp.length - 8)));\n  var timestampHigh = Number('0x' + timestamp.substring(0, Math.max(0, timestamp.length - 8)));\n  buf.writeUInt32LE(timestampLow, 24, false);\n  buf.writeUInt32LE(timestampHigh, 28, false);\n  //random client nonce\n  buf.write(nonce || createPseudoRandomValue(16), 32, 'hex');\n  //zero\n  buf.writeUInt32LE(0, 40);\n  //complete target information block from type 2 message\n  type2message.targetInfo.buffer.copy(buf, 44);\n  //zero\n  buf.writeUInt32LE(0, 44 + type2message.targetInfo.buffer.length);\n  hmac.update(buf.slice(8));\n  var hashedBuffer = hmac.digest();\n  hashedBuffer.copy(buf);\n  return buf;\n}\nfunction createPseudoRandomValue(length) {\n  var str = '';\n  while (str.length < length) {\n    str += Math.floor(Math.random() * 16).toString(16);\n  }\n  return str;\n}\nmodule.exports = {\n  createLMHash: createLMHash,\n  createNTLMHash: createNTLMHash,\n  createLMResponse: createLMResponse,\n  createNTLMResponse: createNTLMResponse,\n  createLMv2Response: createLMv2Response,\n  createNTLMv2Response: createNTLMv2Response,\n  createPseudoRandomValue: createPseudoRandomValue\n};","map":{"version":3,"names":["crypto","require","desjs","md4","createLMResponse","challenge","lmhash","buf","Buffer","alloc","pwBuffer","fill","copy","calculateDES","slice","createLMHash","password","magicKey","from","length","write","toUpperCase","concat","key","message","desKey","i","parity","j","des","DES","create","type","ley","update","createNTLMResponse","ntlmhash","ntlmBuffer","createNTLMHash","md4sum","buffer","createNTLMv2Hash","username","authTargetName","hmac","createHmac","digest","createLMv2Response","type2message","nonce","targetName","ntlm2hash","createPseudoRandomValue","hashedBuffer","createNTLMv2Response","targetInfo","writeUInt32BE","writeUInt32LE","timestamp","Date","now","toString","timestampLow","Number","substring","Math","max","timestampHigh","str","floor","random","module","exports"],"sources":["../src/hash.js"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}