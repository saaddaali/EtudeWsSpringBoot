{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (g && (g = 0, op[0] && (_ = 0)), _) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.NtlmClient = exports.AxiosError = void 0;\nvar axios_1 = __importStar(require(\"axios\"));\nObject.defineProperty(exports, \"AxiosError\", {\n  enumerable: true,\n  get: function () {\n    return axios_1.AxiosError;\n  }\n});\nvar ntlm = __importStar(require(\"./ntlm\"));\nvar https = __importStar(require(\"https\"));\nvar http = __importStar(require(\"http\"));\nvar dev_null_1 = __importDefault(require(\"dev-null\"));\n/**\n* @param credentials An NtlmCredentials object containing the username and password\n* @param AxiosConfig The Axios config for the instance you wish to create\n*\n* @returns This function returns an axios instance configured to use the provided credentials\n*/\nfunction NtlmClient(credentials, AxiosConfig) {\n  var _this = this;\n  var config = AxiosConfig !== null && AxiosConfig !== void 0 ? AxiosConfig : {};\n  if (!config.httpAgent) {\n    config.httpAgent = new http.Agent({\n      keepAlive: true\n    });\n  }\n  if (!config.httpsAgent) {\n    config.httpsAgent = new https.Agent({\n      keepAlive: true\n    });\n  }\n  var client = axios_1.default.create(config);\n  client.interceptors.response.use(function (response) {\n    return response;\n  }, function (err) {\n    return __awaiter(_this, void 0, void 0, function () {\n      var error, ntlmheader, t1Msg, t2Msg, t3Msg, stream_1;\n      var _a, _b;\n      return __generator(this, function (_c) {\n        switch (_c.label) {\n          case 0:\n            error = err.response;\n            if (!(error && error.status === 401 && error.headers['www-authenticate'] && error.headers['www-authenticate'].includes('NTLM') && (!error.config.headers['X-retry'] || error.config.headers['X-retry'] !== 'false'))) return [3 /*break*/, 3];\n            ntlmheader = ((_a = error.headers['www-authenticate'].split(',').find(function (header) {\n              return header.match(/ *NTLM/);\n            })) === null || _a === void 0 ? void 0 : _a.trim()) || '';\n            // This length check is a hack because SharePoint is awkward and will\n            // include the Negotiate option when responding with the T2 message\n            // There is nore we could do to ensure we are processing correctly,\n            // but this is the easiest option for now\n            if (!error.config.headers) {\n              error.config.headers = {};\n            }\n            if (ntlmheader.length < 50) {\n              t1Msg = ntlm.createType1Message(credentials.workstation, credentials.domain);\n              error.config.headers[\"Authorization\"] = t1Msg;\n            } else {\n              t2Msg = ntlm.decodeType2Message((ntlmheader.match(/^NTLM\\s+(.+?)(,|\\s+|$)/) || [])[1]);\n              t3Msg = ntlm.createType3Message(t2Msg, credentials.username, credentials.password, credentials.workstation, credentials.domain);\n              error.config.headers[\"X-retry\"] = \"false\";\n              error.config.headers[\"Authorization\"] = t3Msg;\n            }\n            if (!(error.config.responseType === \"stream\")) return [3 /*break*/, 2];\n            stream_1 = (_b = err.response) === null || _b === void 0 ? void 0 : _b.data;\n            if (!(stream_1 && !stream_1.readableEnded)) return [3 /*break*/, 2];\n            return [4 /*yield*/, new Promise(function (resolve) {\n              stream_1.pipe((0, dev_null_1.default)());\n              stream_1.once('close', resolve);\n            })];\n          case 1:\n            _c.sent();\n            _c.label = 2;\n          case 2:\n            return [2 /*return*/, client(error.config)];\n          case 3:\n            throw err;\n        }\n      });\n    });\n  });\n  return client;\n}\nexports.NtlmClient = NtlmClient;","map":{"version":3,"names":["axios_1","__importStar","require","Object","defineProperty","exports","enumerable","get","AxiosError","ntlm","https","http","dev_null_1","__importDefault","NtlmClient","credentials","AxiosConfig","_this","config","httpAgent","Agent","keepAlive","httpsAgent","client","default","create","interceptors","response","use","err","__awaiter","error","status","headers","includes","ntlmheader","_a","split","find","header","match","trim","length","t1Msg","createType1Message","workstation","domain","t2Msg","decodeType2Message","t3Msg","createType3Message","username","password","responseType","stream_1","_b","data","readableEnded","Promise","resolve","pipe","once","_c","sent"],"sources":["../src/ntlmClient.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}